# Prisma 파일 관리 가이드

## 개요

이 문서는 **Prisma 프로젝트에서 어떤 파일을 Git으로 관리하고, 어떤 파일을 무시해야 하는지**를 설명합니다.

**핵심 원칙**:
- ✅ **스키마와 마이그레이션**: Git에 포함 (팀 전체 공유)
- ❌ **데이터베이스 파일**: Git 무시 (로컬 전용)
- ✅ **설정 파일**: Git에 포함 (환경 설정)

---

## 1. Prisma 디렉토리 구조

```
apps/api/prisma/
├── schema.prisma           ✅ Git에 포함
├── migrations/             ✅ Git에 포함
│   ├── 20251205071831_init/
│   │   └── migration.sql   ✅ Git에 포함
│   └── migration_lock.toml ✅ Git에 포함
├── dev.db                  ❌ Git 무시
├── dev.db-journal          ❌ Git 무시
├── dev.db-shm              ❌ Git 무시
└── dev.db-wal              ❌ Git 무시
```

---

## 2. Git에 포함해야 하는 파일 ✅

### 2.1. `schema.prisma`

**역할**:
- 데이터베이스 스키마 정의
- 모델(테이블) 구조 정의
- 관계(Relationship) 정의
- 인덱스, 제약 조건 정의

**왜 Git에 포함하는가?**
- ✅ 팀 전체가 동일한 DB 구조 사용
- ✅ 버전 관리로 변경 히스토리 추적
- ✅ 코드 리뷰 가능 (PR에서 스키마 변경 확인)
- ✅ 프로덕션 배포 시 필수

**예시**:
```prisma
// apps/api/prisma/schema.prisma

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@map("users")
}
```

**변경 시**:
```bash
# 스키마 수정 후
git add prisma/schema.prisma
git commit -m "feat(db): User 모델에 avatarUrl 필드 추가"
```

---

### 2.2. `migrations/` 디렉토리

**역할**:
- 데이터베이스 변경 히스토리 저장
- 각 마이그레이션 = 하나의 DB 변경
- 순차적으로 적용됨 (타임스탬프 순서)

**구조**:
```
migrations/
├── 20251205071831_init/          ← 첫 번째 마이그레이션
│   └── migration.sql
├── 20251206120000_add_avatar/    ← 두 번째 마이그레이션
│   └── migration.sql
└── migration_lock.toml           ← DB 종류 (sqlite, postgresql 등)
```

**왜 Git에 포함하는가?**
- ✅ **변경 히스토리**: 누가 언제 어떤 변경을 했는지 추적
- ✅ **재현 가능성**: 새로운 개발자가 동일한 DB 구조 생성 가능
- ✅ **롤백 가능**: 문제 발생 시 이전 마이그레이션으로 되돌리기
- ✅ **프로덕션 배포**: 프로덕션 DB에 순차적으로 적용

**예시: migration.sql**
```sql
-- CreateTable
CREATE TABLE "users" (
    "id" TEXT NOT NULL PRIMARY KEY,
    "email" TEXT NOT NULL,
    "password" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "createdAt" DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" DATETIME NOT NULL
);

-- CreateIndex
CREATE UNIQUE INDEX "users_email_key" ON "users"("email");

-- CreateIndex
CREATE INDEX "users_email_idx" ON "users"("email");
```

**변경 시**:
```bash
# 스키마 수정 후 마이그레이션 생성
npx prisma migrate dev --name add_avatar

# Git에 추가
git add prisma/migrations/
git commit -m "feat(db): User 모델에 avatarUrl 필드 추가"
```

---

### 2.3. `migration_lock.toml`

**역할**:
- 어떤 데이터베이스를 사용하는지 기록
- 마이그레이션 실행 시 검증

**내용**:
```toml
# Please do not edit this file manually
# It should be added in your version-control system (i.e. Git)
provider = "sqlite"
```

**왜 Git에 포함하는가?**
- ✅ DB 종류 변경 시 팀 전체에 알림
- ✅ 실수로 다른 DB에 마이그레이션 적용 방지
  - 예: SQLite 마이그레이션을 PostgreSQL에 적용하려고 하면 에러

---

## 3. Git에 포함하지 말아야 하는 파일 ❌

### 3.1. `*.db` (SQLite 데이터베이스 파일)

**역할**:
- 실제 데이터가 저장되는 파일
- 로컬 개발 환경의 데이터

**왜 Git 무시하는가?**
- ❌ **개인 데이터**: 개발자마다 다른 데이터를 가짐
- ❌ **파일 크기**: 데이터가 많아지면 수백 MB~수 GB
- ❌ **충돌 문제**: 여러 개발자가 동시에 수정하면 merge 불가능
- ❌ **보안**: 민감한 데이터가 포함될 수 있음
- ✅ **재생성 가능**: 마이그레이션으로 언제든 재생성 가능

**예시**:
```bash
# dev.db 파일 크기
ls -lh apps/api/prisma/dev.db
# -rw-r--r--  1 user  staff   2.5M 12월  5 16:30 dev.db

# Git에 포함하면 안 됨!
```

**재생성 방법**:
```bash
# 1. DB 파일 삭제
rm apps/api/prisma/dev.db

# 2. 마이그레이션으로 재생성
npx prisma migrate dev
```

---

### 3.2. `*.db-journal` (SQLite 저널 파일)

**역할**:
- 트랜잭션 처리 중 임시 파일
- 데이터베이스 크래시 복구용

**왜 Git 무시하는가?**
- ❌ **임시 파일**: 트랜잭션 완료 후 자동 삭제됨
- ❌ **의미 없음**: Git에 포함해도 사용 불가

---

### 3.3. `*.db-shm` (Shared Memory)

**역할**:
- SQLite WAL 모드의 공유 메모리 파일
- 성능 최적화용

**왜 Git 무시하는가?**
- ❌ **시스템 의존적**: OS마다 다른 내용
- ❌ **자동 생성**: SQLite가 필요 시 자동 생성

---

### 3.4. `*.db-wal` (Write-Ahead Log)

**역할**:
- SQLite WAL 모드의 변경 로그
- 성능 향상 및 동시성 지원

**왜 Git 무시하는가?**
- ❌ **임시 파일**: DB 체크포인트 시 병합됨
- ❌ **로컬 전용**: 개발자마다 다른 내용

---

## 4. .gitignore 설정

### 현재 프로젝트 설정

```gitignore
# .gitignore

# Prisma
# SQLite database files (로컬 개발용, Git에 포함 안 함)
apps/api/prisma/*.db
apps/api/prisma/*.db-journal
apps/api/prisma/*.db-shm
apps/api/prisma/*.db-wal

# Migrations는 Git에 포함 (다른 개발자와 공유)
# apps/api/prisma/migrations/  ← 주석 처리 (포함시킴)
```

**검증 방법**:
```bash
# Git이 추적하는 Prisma 파일 확인
git ls-files apps/api/prisma/

# 출력 예시 (올바른 경우):
# apps/api/prisma/schema.prisma
# apps/api/prisma/migrations/20251205071831_init/migration.sql
# apps/api/prisma/migrations/migration_lock.toml

# dev.db 파일이 나오면 안 됨!
```

---

## 5. 마이그레이션 워크플로우

### 5.1. 스키마 변경 및 마이그레이션 생성

```bash
# 1. schema.prisma 수정
# 예: User 모델에 avatarUrl 필드 추가

# 2. 마이그레이션 생성
npx prisma migrate dev --name add_avatar_to_user

# 3. Git에 추가
git add prisma/schema.prisma
git add prisma/migrations/20251206120000_add_avatar_to_user/
git commit -m "feat(db): User 모델에 avatarUrl 필드 추가"

# 4. Push
git push origin feature/add-avatar
```

**생성되는 파일**:
```
apps/api/prisma/migrations/
└── 20251206120000_add_avatar_to_user/
    └── migration.sql  ← 이 파일을 Git에 포함
```

**migration.sql 예시**:
```sql
-- AlterTable
ALTER TABLE "users" ADD COLUMN "avatarUrl" TEXT;
```

---

### 5.2. 다른 개발자가 마이그레이션 적용

```bash
# 1. 최신 코드 pull
git pull origin main

# 2. 새로운 마이그레이션이 있는지 확인
ls apps/api/prisma/migrations/

# 3. 마이그레이션 적용
cd apps/api
npx prisma migrate dev

# 출력 예시:
# Applying migration `20251206120000_add_avatar_to_user`
# Your database is now in sync with your schema.
```

**자동으로 수행되는 작업**:
1. 새로운 마이그레이션 SQL 실행
2. `dev.db` 파일에 변경 사항 적용
3. Prisma Client 재생성

---

### 5.3. 마이그레이션 충돌 해결

여러 개발자가 동시에 마이그레이션을 생성한 경우:

```bash
# 예시 상황:
# - 개발자 A: 20251206120000_add_avatar/ 생성
# - 개발자 B: 20251206120001_add_phone/ 생성
# - 둘 다 main 브랜치에 merge됨

# 해결 방법 1: 로컬 DB 초기화 (권장)
npx prisma migrate reset

# 해결 방법 2: 수동으로 마이그레이션 적용
npx prisma migrate deploy
```

---

## 6. 프로덕션 환경 고려사항

### 6.1. PostgreSQL로 전환 시

SQLite → PostgreSQL 전환:

```bash
# 1. schema.prisma 수정
# provider = "sqlite" → "postgresql"

# 2. DATABASE_URL 변경
# .env (프로덕션)
DATABASE_URL="postgresql://user:pass@host:5432/db"

# 3. 기존 마이그레이션 삭제
rm -rf prisma/migrations/

# 4. 새로운 마이그레이션 생성 (PostgreSQL용)
npx prisma migrate dev --name init

# 5. Git에 추가
git add prisma/schema.prisma
git add prisma/migrations/
git commit -m "chore(db): SQLite에서 PostgreSQL로 전환"
```

**주의**:
- SQLite 마이그레이션을 PostgreSQL에 직접 적용하면 안 됨
- 전환 시 데이터 마이그레이션 스크립트 별도 작성 필요

---

### 6.2. 프로덕션 배포 시

```bash
# 프로덕션 환경에서 마이그레이션 적용
npx prisma migrate deploy

# 주의:
# - migrate dev가 아닌 migrate deploy 사용
# - 새로운 마이그레이션 생성하지 않음
# - 기존 마이그레이션만 적용
```

---

## 7. 자주 하는 실수 ❌ vs 올바른 방법 ✅

### 실수 1: dev.db를 Git에 포함

```bash
# ❌ 잘못된 방법
git add apps/api/prisma/dev.db
git commit -m "DB 파일 추가"

# ✅ 올바른 방법
# dev.db는 Git 무시
# 마이그레이션만 포함
git add apps/api/prisma/migrations/
git commit -m "feat(db): User 모델 추가"
```

---

### 실수 2: 마이그레이션 직접 수정

```bash
# ❌ 잘못된 방법
# 이미 적용된 마이그레이션 SQL 파일 수정
vim apps/api/prisma/migrations/20251205071831_init/migration.sql

# ✅ 올바른 방법
# 새로운 마이그레이션 생성
npx prisma migrate dev --name fix_user_model
```

**이유**:
- 이미 적용된 마이그레이션 수정 시 다른 개발자와 DB 상태 불일치
- Prisma가 마이그레이션 해시로 변경 감지 → 에러 발생

---

### 실수 3: migration_lock.toml 무시

```bash
# ❌ 잘못된 방법
# .gitignore에 migration_lock.toml 추가
echo "migration_lock.toml" >> .gitignore

# ✅ 올바른 방법
# migration_lock.toml은 Git에 포함
git add apps/api/prisma/migrations/migration_lock.toml
```

**이유**:
- DB 종류 변경 시 팀 전체에 알림 필요
- SQLite ↔ PostgreSQL 전환 시 충돌 방지

---

## 8. 체크리스트

Prisma 파일 관리가 올바른지 확인:

### Git에 포함되어야 하는 파일 ✅

- [ ] `apps/api/prisma/schema.prisma`
- [ ] `apps/api/prisma/migrations/**/*.sql`
- [ ] `apps/api/prisma/migrations/migration_lock.toml`

### Git에 포함되면 안 되는 파일 ❌

- [ ] `apps/api/prisma/*.db`
- [ ] `apps/api/prisma/*.db-journal`
- [ ] `apps/api/prisma/*.db-shm`
- [ ] `apps/api/prisma/*.db-wal`

### .gitignore 설정 확인

```bash
# Git이 무시하는 파일 확인
git status --ignored

# 출력에 dev.db가 있어야 함:
# Ignored files:
#   apps/api/prisma/dev.db
```

---

## 9. 요약

| 파일/디렉토리 | Git 포함 | 이유 |
|--------------|---------|------|
| `schema.prisma` | ✅ | DB 스키마 정의 (팀 공유) |
| `migrations/` | ✅ | 변경 히스토리 (버전 관리) |
| `migration_lock.toml` | ✅ | DB 종류 고정 (충돌 방지) |
| `*.db` | ❌ | 로컬 데이터 (개인별 다름) |
| `*.db-journal` | ❌ | 임시 파일 (자동 생성/삭제) |
| `*.db-shm` | ❌ | 공유 메모리 (시스템 의존적) |
| `*.db-wal` | ❌ | WAL 로그 (임시 파일) |

---

## 10. 추가 리소스

- [Prisma 공식 문서 - Migrations](https://www.prisma.io/docs/concepts/components/prisma-migrate)
- [로컬 개발 환경 세팅 가이드](/docs/guides/LOCAL-SETUP.md)
- [Prisma ORM 가이드](/docs/guides/DATABASE-QUERY.md)

---

**마지막 업데이트**: 2025-12-05
**작성자**: Backend Team
