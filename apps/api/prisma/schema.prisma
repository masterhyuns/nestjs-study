// Prisma 스키마 정의
//
// 협업 플랫폼 데이터 모델
//
// 컨벤션:
// - 테이블명: PascalCase (User, Workspace)
// - 컬럼명: camelCase (createdAt, userId)
// - 관계명: 명시적 (user, workspace, project)
// - ID: cuid() 사용 (성능 + 분산 환경 대비)
// - 타임스탬프: createdAt, updatedAt 필수
// - 소프트 삭제: deletedAt (선택적)

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

/**
 * @datasource SQLite (Docker 불필요)
 *
 * @why-sqlite
 * PostgreSQL 대신 SQLite를 사용하는 이유:
 * - Docker를 사용할 수 없는 환경
 * - 별도 DB 서버 설치 불필요
 * - 파일 기반으로 로컬에서 바로 실행 가능
 * - 개발/테스트 환경에 최적
 *
 * @differences PostgreSQL vs SQLite
 * 1. UUID → String (cuid 사용)
 * 2. JSONB → TEXT (JSON 문자열)
 * 3. TIMESTAMPTZ → DateTime
 * 4. CASCADE 동작 동일
 *
 * @production
 * 프로덕션 환경에서는 여전히 PostgreSQL 권장
 * - 동시 쓰기 성능
 * - 네트워크 접근
 * - 고급 기능 (JSONB, Full-text search 등)
 *
 * @migration
 * SQLite → PostgreSQL 마이그레이션:
 * 1. schema.prisma에서 provider를 "postgresql"로 변경
 * 2. DATABASE_URL 환경 변수 변경
 * 3. prisma migrate dev 실행
 */
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

/// 사용자 엔티티
///
/// 플랫폼의 핵심 사용자 정보
/// 멀티 테넌시: organizationId로 조직 분리
model User {
  /// 사용자 고유 ID (cuid)
  id String @id @default(cuid())

  /// 이메일 (unique, lowercase)
  email String @unique

  /// 해싱된 비밀번호 (bcrypt)
  password String

  /// 표시 이름
  name String

  /// 프로필 이미지 URL
  avatarUrl String?

  /// 권한 역할
  role UserRole @default(MEMBER)

  /// 활성 상태
  isActive Boolean @default(true)

  /// 이메일 인증 여부
  emailVerified Boolean @default(false)

  /// 생성일시 (UTC)
  createdAt DateTime @default(now())

  /// 수정일시 (UTC)
  updatedAt DateTime @updatedAt

  /// 소프트 삭제 (GDPR 준수)
  deletedAt DateTime?

  /// 관계: 워크스페이스 멤버십
  workspaceMembers WorkspaceMember[]

  /// 관계: 생성한 프로젝트
  createdProjects Project[]

  /// 관계: 할당된 태스크
  assignedTasks Task[]

  /// 관계: 작성한 댓글
  comments Comment[]

  @@index([email])
  @@index([createdAt])
  @@map("users")
}

/// 사용자 역할 Enum
enum UserRole {
  /// 시스템 관리자
  SUPER_ADMIN

  /// 조직 관리자
  ORG_ADMIN

  /// 프로젝트 관리자
  MANAGER

  /// 일반 멤버
  MEMBER
}

/// 워크스페이스 (멀티 테넌시)
///
/// 조직 단위로 데이터 격리
model Workspace {
  /// 워크스페이스 ID
  id String @id @default(cuid())

  /// 워크스페이스 이름
  name String

  /// 슬러그 (URL용, unique)
  slug String @unique

  /// 설명
  description String?

  /// 로고 URL
  logoUrl String?

  /// 활성 상태
  isActive Boolean @default(true)

  /// 생성일시
  createdAt DateTime @default(now())

  /// 수정일시
  updatedAt DateTime @updatedAt

  /// 관계: 멤버
  members WorkspaceMember[]

  /// 관계: 프로젝트
  projects Project[]

  @@index([slug])
  @@map("workspaces")
}

/// 워크스페이스 멤버십
///
/// 사용자 ↔ 워크스페이스 다대다 관계
model WorkspaceMember {
  /// 멤버십 ID
  id String @id @default(cuid())

  /// 워크스페이스 ID
  workspaceId String

  /// 사용자 ID
  userId String

  /// 워크스페이스 내 역할
  role MemberRole @default(MEMBER)

  /// 초대 수락 여부
  isAccepted Boolean @default(false)

  /// 가입일시
  joinedAt DateTime @default(now())

  /// 관계: 워크스페이스
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  /// 관계: 사용자
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
  @@map("workspace_members")
}

/// 워크스페이스 멤버 역할
enum MemberRole {
  OWNER
  ADMIN
  MEMBER
  GUEST
}

/// 프로젝트
model Project {
  /// 프로젝트 ID
  id String @id @default(cuid())

  /// 워크스페이스 ID
  workspaceId String

  /// 프로젝트 이름
  name String

  /// 프로젝트 키 (예: PROJ)
  key String

  /// 설명
  description String?

  /// 상태
  status ProjectStatus @default(ACTIVE)

  /// 시작일
  startDate DateTime?

  /// 종료일
  endDate DateTime?

  /// 생성자 ID
  createdById String

  /// 생성일시
  createdAt DateTime @default(now())

  /// 수정일시
  updatedAt DateTime @updatedAt

  /// 관계: 워크스페이스
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  /// 관계: 생성자
  createdBy User @relation(fields: [createdById], references: [id])

  /// 관계: 태스크
  tasks Task[]

  @@unique([workspaceId, key])
  @@index([workspaceId])
  @@index([createdById])
  @@map("projects")
}

/// 프로젝트 상태
enum ProjectStatus {
  ACTIVE
  ARCHIVED
  COMPLETED
}

/// 태스크
model Task {
  /// 태스크 ID
  id String @id @default(cuid())

  /// 프로젝트 ID
  projectId String

  /// 태스크 제목
  title String

  /// 태스크 설명 (Markdown)
  description String?

  /// 상태
  status TaskStatus @default(TODO)

  /// 우선순위
  priority TaskPriority @default(MEDIUM)

  /// 담당자 ID
  assigneeId String?

  /// 예상 소요 시간 (시간)
  estimatedHours Float?

  /// 실제 소요 시간 (시간)
  actualHours Float?

  /// 기한
  dueDate DateTime?

  /// 생성일시
  createdAt DateTime @default(now())

  /// 수정일시
  updatedAt DateTime @updatedAt

  /// 완료일시
  completedAt DateTime?

  /// 관계: 프로젝트
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  /// 관계: 담당자
  assignee User? @relation(fields: [assigneeId], references: [id])

  /// 관계: 댓글
  comments Comment[]

  @@index([projectId])
  @@index([assigneeId])
  @@index([status])
  @@index([dueDate])
  @@map("tasks")
}

/// 태스크 상태
enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  BLOCKED
}

/// 태스크 우선순위
enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

/// 댓글
model Comment {
  /// 댓글 ID
  id String @id @default(cuid())

  /// 태스크 ID
  taskId String

  /// 작성자 ID
  userId String

  /// 댓글 내용 (Markdown)
  content String

  /// 생성일시
  createdAt DateTime @default(now())

  /// 수정일시
  updatedAt DateTime @updatedAt

  /// 삭제일시 (소프트 삭제)
  deletedAt DateTime?

  /// 관계: 태스크
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  /// 관계: 작성자
  user User @relation(fields: [userId], references: [id])

  @@index([taskId])
  @@index([userId])
  @@map("comments")
}
